#!/bin/bash

set -e

WORKDIR=verilator

if [[ -e $WORKDIR/checksum ]] && md5sum --status --check $WORKDIR/checksum; then
  echo "$WORKDIR up to date"
  exit 0
else
  echo "Rebuilding $WORKDIR"
  rm -rf $WORKDIR
fi

# Build verilator
REMOTE=http://github.com/verilator/verilator
REFSPEC=v4.034

git clone $REMOTE $WORKDIR

pushd $WORKDIR
unset VERILATOR_ROOT
git checkout $REFSPEC
mkdir install
autoconf
./configure --prefix=$(readlink -f install) CXX=clang++
make -j$(nproc)
make install
popd

# Update checksum
md5sum $BASH_SOURCE > $WORKDIR/checksum
